<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Laundry - Request Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        /* Custom styles for the separator line, mimicking the image */
        .separator-line {
            width: 50%;
            height: 2px;
            background-color: black;
            margin: 0 auto 10px;
        }
        .highlight-yellow {
            background-color: yellow;
            padding: 2px 8px;
            font-weight: bold;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-6">

    <div class="w-full max-w-md bg-white p-6 md:p-8 rounded-lg shadow-lg" x-data="laundryOrderApp()">
        <div class="text-center mb-6">
            <div class="separator-line"></div>
            <span class="highlight-yellow text-xl">Request Delivery</span>
            <div class="separator-line mt-2"></div>
        </div>

        <div x-show="loading" class="text-center py-8 text-gray-600">Loading order details...</div>
        <div x-show="error" class="text-center py-8 text-red-600 font-bold" x-text="error"></div>

        <template x-if="order && !loading && !error">
            <div>
                <h2 class="text-2xl font-bold mb-4">King Laundry</h2>

                <p class="mb-2"><strong>Invoice No.:</strong> <span x-text="order.invoice_id"></span></p>
                <p class="mb-2"><strong>Pickup Date:</strong> <span x-text="formatDate(order.created)"></span></p>
                <p class="mb-2"><strong>Payment Status:</strong> <span x-text="paymentStatus"></span></p>

                <p class="mb-2"><strong>Quantity:</strong> <span x-text="order.quantity"></span> KG</p>
                <template x-if="parsedItems">
                    <ul class="list-disc pl-5 mb-4">
                        <template x-for="(value, key) in parsedItems" :key="key">
                            <li x-show="value > 0" class="text-sm">
                                <span x-text="`${key.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase())}: ${value}`"></span>
                            </li>
                        </template>
                    </ul>
                </template>

                <p class="text-center text-2xl font-extrabold my-6">Total Price: USD <span x-text="order.grand_total ? order.grand_total.toFixed(2) : '0.00'"></span></p>

                <h3 class="text-center text-xl font-bold mb-4">Pay now!</h3>

                <div class="flex flex-col space-y-4">
                    <button @click="payWith('ABA')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        ABA
                    </button>
                    <button @click="payWith('ACLEDA')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        ACLEDA BANK
                    </button>
                </div>

                <p class="text-center text-gray-500 text-sm mt-6">Authorized by Cloth Bird</p>
            </div>
        </template>

        <template x-if="!order && !loading && !error">
            <div class="text-center py-8 text-gray-600">
                <p>No order found for the provided invoice ID. Please check the URL.</p>
                <p class="text-sm mt-2">Example: `?invoice_id=KIN-002-012-033`</p>
            </div>
        </template>
    </div>

    <script>
        function laundryOrderApp() {
            return {
                pb: null,
                order: null,
                orderDetails: null,
                orderPayment: null,
                khqrLinks: [], // Store all relevant khqr links for the shop
                abaLink: '',
                acledaLink: '',
                loading: true,
                error: null,
                invoiceId: null,
                parsedItems: {}, // To store parsed JSON items

                get paymentStatus() {
                    return this.orderPayment ? this.orderPayment.status : 'N/A';
                },

                init() {
                    this.pb = new PocketBase('https://clothbird.reankhode.com'); // Replace with your PocketBase URL
                    const urlParams = new URLSearchParams(window.location.search);
                    this.invoiceId = urlParams.get('invoice_id');

                    if (this.invoiceId) {
                        this.fetchOrderData();
                    } else {
                        this.error = "No invoice ID found in the URL. Please provide an invoice_id as a query parameter (e.g., ?invoice_id=KIN-002-012-033).";
                        this.loading = false;
                    }
                },

                async fetchOrderData() {
                    this.loading = true;
                    this.error = null;
                    try {
                        // 1. Fetch the main order by invoice_id
                        const orderResult = await this.pb.collection('orders').getList(1, 1, {
                            filter: `invoice_id="${this.invoiceId}"`,
                            expand: `item,user,item.shop,item.service,order_details_via_order,order_payments_via_order`
                            // Assuming you have a 'pickup_date' field in your 'orders' collection
                            // and 'quantity_kg' field for total quantity in kg
                        });

                        if (orderResult.items.length === 0) {
                            this.order = null;
                            this.loading = false;
                            return;
                        }
                        this.order = orderResult.items[0];

                        // 2. Fetch order details related to this order
                        const orderDetailsResult = await this.pb.collection('order_details').getList(1, 1, {
                            filter: `order="${this.order.id}"`
                        });

                        if (orderDetailsResult.items.length > 0) {
                            this.orderDetails = orderDetailsResult.items[0];

                            // *** REMOVE THE JSON.parse() IF POCKETBASE SDK HANDLES IT ***
                            // Instead of:
                            // try {
                            //     this.parsedItems = JSON.parse(this.orderDetails.items);
                            // } catch (e) {
                            //     console.error("Error parsing items JSON:", e);
                            //     this.parsedItems = {};
                            // }
                            // Do this:
                            this.parsedItems = this.orderDetails.items; // Direct assignment, PocketBase SDK already parses it
                            if (typeof this.parsedItems !== 'object' || this.parsedItems === null) {
                                // Fallback if for some reason it's not an object (e.g., null or malformed data in DB)
                                console.warn("order_details.items is not an object, initializing as empty:", this.parsedItems);
                                this.parsedItems = {};
                            }

                        } else {
                            this.orderDetails = null;
                            this.parsedItems = {};
                        }

                        // 3. Fetch order payments related to this order
                        const orderPaymentResult = await this.pb.collection('order_payments').getList(1, 1, {
                            filter: `order="${this.order.id}"`
                        });

                        if (orderPaymentResult.items.length > 0) {
                            this.orderPayment = orderPaymentResult.items[0];
                        } else {
                            this.orderPayment = null;
                        }

                        // --- Add these console.logs ---
                        console.log("Fetched Order:", this.order);
                        console.log("Order Expand Property:", this.order.expand);
                        if (this.order.expand) {
                            console.log("Expanded Item:", this.order.expand.item);
                            if (this.order.expand.item) {
                                console.log("Expanded Item Shop:", this.order.expand.item.shop);
                            }
                        }
                        // --- End console.logs ---

                        // 4. After fetching the order and getting the shop ID, fetch payment links
                        if (this.order.expand && this.order.expand.item && this.order.expand.item.shop) {
                            // Access shop ID via the expanded 'item' record
                            await this.fetchPaymentLinks(this.order.expand.item.shop.id, this.order.grand_total);
                        } else {
                            console.warn("Shop relation not found or expanded on order's item record. Cannot fetch payment links.");
                            this.abaLink = '';
                            this.acledaLink = '';
                        }
                    } catch (e) {
                        console.error("Error fetching order data:", e);
                        this.error = "Failed to fetch order information. Please ensure the invoice ID is correct and try again.";
                    } finally {
                        this.loading = false;
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    try {
                        const date = new Date(dateString);
                        // Format as DD-MM-YYYY
                        return new Intl.DateTimeFormat('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }).format(date);
                    } catch (e) {
                        console.error("Error formatting date:", e);
                        return 'Invalid Date';
                    }
                },

                async fetchPaymentLinks(shopId, amount) {
                    try {
                        const linksResult = await this.pb.collection('khqr_links').getList(1, 50, { // Fetch up to 50 links for this shop
                            filter: `amount="${amount}"`
                        });

                        if (linksResult.items.length > 0) {
                            const specificLink = linksResult.items[0]; // Assuming one link per amount for a shop
                            this.abaLink = specificLink.aba_link || '';
                            this.acledaLink = specificLink.acleda_link || '';
                        } else {
                            console.log(`No specific KHQR link found for shop ${shopId} and amount ${amount}.`);
                            this.abaLink = '';
                            this.acledaLink = '';

                            // TODO: Implement logic for default link for custom amount or default 0
                            // Example for a default link:
                            /*
                            const defaultLinks = await this.pb.collection('khqr_links').getList(1, 1, {
                                filter: `shop = "${shopId}" && amount = 0` // Or a designated 'custom_amount' entry
                            });
                            if (defaultLinks.items.length > 0) {
                                this.abaLink = defaultLinks.items[0].aba_link || '';
                                this.acledaLink = defaultLinks.items[0].acleda_link || '';
                            } else {
                                // Fallback if even default 0 link is not found
                                console.warn("No specific or default KHQR link found for this shop and amount.");
                            }
                            */
                        }
                    } catch (e) {
                        console.error("Error fetching payment links:", e);
                        this.abaLink = '';
                        this.acledaLink = '';
                    }
                },

                payWith(method) {
                    let deepLink = '';
                    if (method === 'ABA' && this.abaLink) {
                        deepLink = this.abaLink;
                    } else if (method === 'ACLEDA' && this.acledaLink) {
                        deepLink = this.acledaLink;
                    }

                    if (deepLink) {
                        window.location.href = deepLink; // This will attempt to open the app
                    } else {
                        alert(`No deep link available for ${method} at this amount.`);
                    }
                }
            }
        }
    </script>
</body>
</html>
