<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        /* Custom styles for the separator line, mimicking the image */
        .separator-line {
            width: 50%;
            height: 2px;
            background-color: black;
            margin: 0 auto 10px;
        }
        .highlight-yellow {
            background-color: yellow;
            padding: 2px 8px;
            font-weight: bold;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-6">
    <div class="w-full max-w-md bg-white p-6 md:p-8 rounded-lg shadow-lg" x-data="laundryOrderApp()">
        <div x-show="loading" class="text-center py-8 text-gray-600">Loading order details...</div>
        <div x-show="error" class="text-center py-8 text-red-600 font-bold" x-text="error"></div>
        <template x-if="order && !loading && !error">
            <div>
                <h2 class="text-2xl font-bold mb-8 text-center">
                    <span x-text="shopDetails.name"></span>
                    <button @click="showDeliveryModal = true" class="ml-2 px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm hover:bg-gray-300">Request Delivery</button>
                </h2>
                <p class="mb-2"><strong>Invoice:</strong> <span x-text="order.invoice_id"></span></p>
                <p class="mb-2"><strong>Pickup Date:</strong> <span x-text="formatDate(order.pickup_date)"></span></p>
                <p class="mb-2"><strong>Payment Status:</strong> <span x-text="paymentStatus"></span></p>
                <p class="mb-2"><strong>Quantity:</strong> <span x-text="order.quantity"></span> KG</p>
                <template x-if="parsedItems">
                    <ul class="list-disc pl-5 mb-10">
                        <template x-for="(value, key) in parsedItems" :key="key">
                            <li x-show="value > 0" class="text-sm">
                                <span x-text="`${key.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase())}: ${value}`"></span>
                            </li>
                        </template>
                    </ul>
                </template>
                <p class="text-center text-xl font-extrabold my-2">Total Price: USD <span x-text="order.grand_total ? order.grand_total.toFixed(2) : '0.00'"></span></p>
                <h3 class="text-center text-ml font-bold mb-4">Pay now!</h3>
                <div class="flex flex-col space-y-4">
                    <button @click="payWith('ABA')" :disabled="!abaLink" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        ABA
                    </button>
                    <button @click="payWith('ACLEDA')" :disabled="!acledaLink" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        ACLEDA BANK
                    </button>
                </div>
                <p class="text-center text-gray-500 text-sm mt-6">Authorized by Cloth Bird</p>
            </div>
        </template>
        <template x-if="!order && !loading && !error">
            <div class="text-center py-8 text-gray-600">
                <p>No order found for the provided invoice ID. Please check the URL.</p>
                <p class="text-sm mt-2">Example: `?id=KIN-000-000-001`</p>
            </div>
        </template>

        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" x-show="showDeliveryModal" x-transition.opacity>
            <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Request Delivery</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500 mb-4">Please enter your phone number for delivery.</p>
                        <input type="text" x-model="deliveryPhoneNumber" placeholder="Enter phone number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p x-show="deliveryError" class="text-red-500 text-sm mt-2" x-text="deliveryError"></p>
                        <p x-show="deliverySuccess" class="text-green-600 text-sm mt-2" x-text="deliverySuccess"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button @click="submitDeliveryRequest()" :disabled="deliverySubmitting" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!deliverySubmitting">Submit Request</span>
                            <span x-show="deliverySubmitting">Submitting...</span>
                        </button>
                        <button @click="showDeliveryModal = false; deliveryError = ''; deliverySuccess = ''; deliveryPhoneNumber = ''" class="mt-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function laundryOrderApp() {
            return {
                pb: null,
                order: null,
                orderDetails: null,
                orderPayment: null,
                shopDetails: null,
                abaLink: '',
                acledaLink: '',
                loading: true,
                error: null,
                invoiceId: null,
                parsedItems: {},
                showDeliveryModal: false, // Control modal visibility
                deliveryPhoneNumber: '', // Store phone number from input
                deliveryError: '', // Store delivery submission errors
                deliverySuccess: '', // Store delivery submission success message
                deliverySubmitting: false, // To prevent multiple submissions

                get paymentStatus() {
                    return this.orderPayment ? this.orderPayment.status : 'N/A';
                },

                init() {
                    this.pb = new PocketBase('https://clothbird.reankhode.com');

                    const urlParams = new URLSearchParams(window.location.search);
                    this.invoiceId = urlParams.get('id');

                    if (this.invoiceId) {
                        this.fetchOrderData();
                    } else {
                        this.error = "No invoice ID found in the URL. Please provide an {id} as a query parameter (e.g., ?id=KIN-000-000-001).";
                        this.loading = false;
                    }
                },

                async fetchOrderData() {
                    this.loading = true;
                    this.error = null;
                    try {
                        const orderResult = await this.pb.collection('orders').getList(1, 1, {
                            filter: `invoice_id="${this.invoiceId.toUpperCase()}"`,
                            expand: `item,user,item.shop,item.service,order_details_via_order,order_payments_via_order`
                        });

                        if (orderResult.items.length === 0) {
                            this.order = null;
                            this.loading = false;
                            return;
                        }
                        this.order = orderResult.items[0];

                        if (!this.order.expand.item.shop) {
                            console.error("Order record does not have a 'shop' relation ID. Cannot fetch payment links.");
                            this.error = "Order data incomplete: shop information missing.";
                            this.loading = false;
                            return;
                        }

                        this.shopDetails = await this.pb.collection('shops').getOne(this.order.expand.item.shop);

                        const orderDetailsResult = await this.pb.collection('order_details').getList(1, 1, {
                            filter: `order="${this.order.id}"`
                        });

                        if (orderDetailsResult.items.length > 0) {
                            this.orderDetails = orderDetailsResult.items[0];
                            this.parsedItems = this.orderDetails.items;
                        } else {
                            this.orderDetails = null;
                            this.parsedItems = {};
                        }

                        const orderPaymentResult = await this.pb.collection('order_payments').getList(1, 1, {
                            filter: `order="${this.order.id}"`
                        });

                        if (orderPaymentResult.items.length > 0) {
                            this.orderPayment = orderPaymentResult.items[0];
                        } else {
                            this.orderPayment = null;
                        }

                        await this.resolvePaymentLinks(this.order.expand.item.shop, this.order.grand_total);


                    } catch (e) {
                        console.error("Error fetching order data:", e);
                        this.error = "Failed to fetch order information. Please ensure the invoice ID is correct and try again.";
                    } finally {
                        this.loading = false;
                    }
                },

                async resolvePaymentLinks(shopId, amount) {
                    this.abaLink = '';
                    this.acledaLink = '';

                    try {
                        const specificLinkResult = await this.pb.collection('khqr_links').getList(1, 1, {
                            filter: `shop="${shopId}"&&amount=${amount}`
                        });

                        if (specificLinkResult.items.length > 0) {
                            const specificLink = specificLinkResult.items[0];
                            this.abaLink = specificLink.aba_link || '';
                            this.acledaLink = specificLink.acleda_link || '';
                            console.log("Using specific KHQR links.");
                        } else {
                            console.log(`No specific KHQR link found for shop ${shopId} and amount ${amount}. Using default links.`);
                            if (this.shopDetails) {
                                this.abaLink = this.shopDetails.aba_link || '';
                                this.acledaLink = this.shopDetails.acleda_link || '';
                            } else {
                                console.warn("Shop details not available to fetch default links.");
                            }
                        }
                    } catch (e) {
                        console.error("Error resolving payment links:", e);
                        this.abaLink = '';
                        this.acledaLink = '';
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    try {
                        const date = new Date(dateString);
                        return new Intl.DateTimeFormat('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }).format(date);
                    } catch (e) {
                        console.error("Error formatting date:", e);
                        return 'Invalid Date';
                    }
                },

                payWith(method) {
                    let deepLink = '';
                    if (method === 'ABA' && this.abaLink) {
                        deepLink = this.abaLink;
                    } else if (method === 'ACLEDA' && this.acledaLink) {
                        deepLink = this.acledaLink;
                    }

                    if (deepLink) {
                        window.location.href = deepLink;
                    } else {
                        alert(`No deep link available for ${method} at this amount.`);
                    }
                },

                async submitDeliveryRequest() {
                    this.deliveryError = '';
                    this.deliverySuccess = '';
                    this.deliverySubmitting = true;

                    if (!this.deliveryPhoneNumber) {
                        this.deliveryError = "Please enter a phone number.";
                        this.deliverySubmitting = false;
                        return;
                    }

                    if (!this.order || !this.order.id) {
                        this.deliveryError = "Order information not available for delivery request.";
                        this.deliverySubmitting = false;
                        return;
                    }

                    try {
                        const data = {
                            "order": this.order.id,
                            "phone": this.deliveryPhoneNumber,
                            "amount": this.order.grand_total, // Assuming delivery amount is grand_total
                            "latitude": 0, // Placeholder, you might want to get actual location
                            "longitude": 0, // Placeholder, you might want to get actual location
                            "type": "Pick" // Assuming 'Pick' is the type for delivery requests
                        };
                        await this.pb.collection('deliveries').create(data);
                        this.deliverySuccess = "Delivery request submitted successfully!";
                        this.deliveryPhoneNumber = ''; // Clear input after success
                        // You might want to close the modal after a short delay or on a new button click
                        setTimeout(() => {
                            this.showDeliveryModal = false;
                            this.deliverySuccess = '';
                        }, 2000);
                    } catch (e) {
                        console.error("Error submitting delivery request:", e);
                        this.deliveryError = "Failed to submit delivery request. Please try again.";
                    } finally {
                        this.deliverySubmitting = false;
                    }
                }
            }
        }
    </script>
</body>
</html>